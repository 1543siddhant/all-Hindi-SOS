import streamlit as st
import smtplib
from email.message import EmailMessage

# Global sender credentials (рд╕рднреА рдкреГрд╖реНрдареЛрдВ рдХреЗ рд▓рд┐рдП)
SENDER_EMAIL = "tensortitans2612@gmail.com"
SENDER_PASSWORD = "hjcy lblh gwhv jmzk"

# App Title & Layout
st.set_page_config(page_title="рд╕реЗрдлрд░реВрдЯ рд╕рд┐рд╕реНрдЯрдо", layout="wide")

# Sidebar Navigation (Dropdown on Right)
st.sidebar.title("ЁЯНГ рдХреЗрдпрд░рд╡реЙрд▓реНрдЯ SOS рд╣рдм")
page = st.sidebar.selectbox("рдПрдХ рд╡рд┐рдХрд▓реНрдк рдЪреБрдиреЗрдВ", ["ЁЯУД рдпрд╛рддреНрд░рд╛ рд╡рд┐рд╡рд░рдг рдЬреЛрдбрд╝реЗрдВ", "ЁЯУН рд╕реНрдерд╛рди рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдПрдВ", "ЁЯЪи рдЖрдкрд╛рддрдХрд╛рд▓реАрди SOS рдкреНрд░рдгрд╛рд▓реА"])

# ------------------------ рдпрд╛рддреНрд░рд╛ рд╡рд┐рд╡рд░рдг рдЬреЛрдбрд╝реЗрдВ (Add Travel Details) Page ------------------------
if page == "ЁЯУД рдпрд╛рддреНрд░рд╛ рд╡рд┐рд╡рд░рдг рдЬреЛрдбрд╝реЗрдВ":
    st.title("ЁЯЪЦ рд╕реЗрдлрд░реВрдЯ рдЖрдкрд╛рддрдХрд╛рд▓реАрди рд░рд┐рдкреЛрд░реНрдЯрд┐рдВрдЧ рдкреНрд░рдгрд╛рд▓реА")

    # рд╣рд╛рд░реНрдбрдХреЛрдбреЗрдб рд░рд┐рд╕реАрд╡рд░ рдИрдореЗрд▓ (Editable)
    default_receivers = "siddhantpatil1543@gmail.com, siddhantpatil1540@gmail.com, maitreyeeb2004@gmail.com"
    receiver_emails = st.text_area("ЁЯУе рд░рд┐рд╕реАрд╡рд░ рдИрдореЗрд▓ рджрд░реНрдЬ рдХрд░реЗрдВ (рд╕рдВрдкрд╛рджрди рдпреЛрдЧреНрдп)", default_receivers)

    # рд╡рд╛рд╣рди рдФрд░ рдбреНрд░рд╛рдЗрд╡рд░ рд╡рд┐рд╡рд░рдг
    vehicle_number = st.text_input("ЁЯЪЧ рд╡рд╛рд╣рди рд╕рдВрдЦреНрдпрд╛", placeholder="рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, MH12AB1234 рджрд░реНрдЬ рдХрд░реЗрдВ")
    vehicle_type = st.selectbox("ЁЯЪШ рд╡рд╛рд╣рди рдкреНрд░рдХрд╛рд░", ["рдХрд╛рд░", "рдмрд╛рдЗрдХ", "рдСрдЯреЛ", "рдЕрдиреНрдп"])
    vehicle_color = st.text_input("ЁЯОи рд╡рд╛рд╣рди рдХрд╛ рд░рдВрдЧ", placeholder="рдЙрджрд╛рд╣рд░рдг: рд╕рдлреЗрдж, рдХрд╛рд▓рд╛, рд▓рд╛рд▓")
    driver_name = st.text_input("ЁЯзСтАНтЬИя╕П рдбреНрд░рд╛рдЗрд╡рд░ рдХрд╛ рдирд╛рдо (Uber/Ola)", placeholder="рдбреНрд░рд╛рдЗрд╡рд░ рдХрд╛ рдирд╛рдо рджрд░реНрдЬ рдХрд░реЗрдВ")
    location = st.text_area("ЁЯУН рд╕реНрдерд╛рди рд╡рд┐рд╡рд░рдг", placeholder="рдЕрдкрдирд╛ рд╡рд░реНрддрдорд╛рди рд╕реНрдерд╛рди рдпрд╛ Google Maps рд▓рд┐рдВрдХ рджрд░реНрдЬ рдХрд░реЗрдВ")
    message = st.text_area("ЁЯУЭ рдЕрддрд┐рд░рд┐рдХреНрдд рд╕рдВрджреЗрд╢ (рд╡реИрдХрд▓реНрдкрд┐рдХ)", placeholder="рдЕрдкрдиреА рдЖрдкрд╛рддрдХрд╛рд▓реАрди рд╕реНрдерд┐рддрд┐ рдХрд╛ рд╡рд░реНрдгрди рдХрд░реЗрдВ")

    # рд╡рд╛рд╣рди/рдбреНрд░рд╛рдЗрд╡рд░ рдХреА рдЫрд╡рд┐ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ (рд╡реИрдХрд▓реНрдкрд┐рдХ)
    uploaded_file = st.file_uploader("ЁЯУ╖ рд╡рд╛рд╣рди/рдбреНрд░рд╛рдЗрд╡рд░ рдХреА рдЫрд╡рд┐ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ (рд╡реИрдХрд▓реНрдкрд┐рдХ)", type=["png", "jpg", "jpeg"])

    # рдИрдореЗрд▓ рднреЗрдЬрдиреЗ рдХрд╛ рдмрдЯрди
    if st.button("ЁЯЪА рдЖрдкрд╛рддрдХрд╛рд▓реАрди рд░рд┐рдкреЛрд░реНрдЯ рднреЗрдЬреЗрдВ"):
        if receiver_emails and vehicle_number and vehicle_color and driver_name and location:
            email_list = [email.strip() for email in receiver_emails.split(",")]

            # рдИрдореЗрд▓ рд╕рд╛рдордЧреНрд░реА рдХрд╛ рдирд┐рд░реНрдорд╛рдг
            email_body = f"""
            ЁЯЪи *рд╕реЗрдлрд░реВрдЯ рд╕рд┐рд╕реНрдЯрдо рд╕реЗ рдЖрдкрд╛рддрдХрд╛рд▓реАрди рд╕реВрдЪрдирд╛* ЁЯЪи
            
            ЁЯУМ *рд╡рд╛рд╣рди рд╡рд┐рд╡рд░рдг:*
            - рд╡рд╛рд╣рди рд╕рдВрдЦреНрдпрд╛: {vehicle_number}
            - рд╡рд╛рд╣рди рдкреНрд░рдХрд╛рд░: {vehicle_type}
            - рд╡рд╛рд╣рди рдХрд╛ рд░рдВрдЧ: {vehicle_color}
            
            ЁЯСд *рдбреНрд░рд╛рдЗрд╡рд░ рд╡рд┐рд╡рд░рдг:*
            - рдбреНрд░рд╛рдЗрд╡рд░ рдХрд╛ рдирд╛рдо: {driver_name}
            
            ЁЯУН *рд╕реНрдерд╛рди:*
            {location}
            
            ЁЯУЭ *рдЕрддрд┐рд░рд┐рдХреНрдд рд╕рдВрджреЗрд╢:*
            {message if message else "рдХреЛрдИ рдЕрддрд┐рд░рд┐рдХреНрдд рдЬрд╛рдирдХрд╛рд░реА рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВ рд╣реИред"}
            """

            # рдИрдореЗрд▓ рдмрдирд╛рдПрдВ
            msg = EmailMessage()
            msg["From"] = SENDER_EMAIL
            msg["To"] = ", ".join(email_list)
            msg["Subject"] = "ЁЯЪи рд╕реЗрдлрд░реВрдЯ рдЖрдкрд╛рддрдХрд╛рд▓реАрди рд╕реВрдЪрдирд╛"
            msg.set_content(email_body)

            # рдпрджрд┐ рдХреЛрдИ рдЫрд╡рд┐ рдЕрдкрд▓реЛрдб рдХреА рдЧрдИ рд╣реЛ рддреЛ рдЙрд╕реЗ рдЬреЛрдбрд╝реЗрдВ
            if uploaded_file is not None:
                file_data = uploaded_file.read()
                file_name = uploaded_file.name
                msg.add_attachment(file_data, maintype="image", subtype=file_name.split(".")[-1], filename=file_name)

            try:
                server = smtplib.SMTP("smtp.gmail.com", 587)
                server.starttls()
                server.login(SENDER_EMAIL, SENDER_PASSWORD)
                server.send_message(msg)
                server.quit()
                
                st.success(f"тЬЕ рдЖрдкрд╛рддрдХрд╛рд▓реАрди рд░рд┐рдкреЛрд░реНрдЯ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рднреЗрдЬ рджреА рдЧрдИ рд╣реИ: {', '.join(email_list)}")
            except Exception as e:
                st.error(f"тЭМ рдИрдореЗрд▓ рднреЗрдЬрдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓: {e}")
        else:
            st.warning("тЪая╕П рдХреГрдкрдпрд╛ рднреЗрдЬрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рд╕рднреА рдЖрд╡рд╢реНрдпрдХ рдлрд╝реАрд▓реНрдб рднрд░реЗрдВред")

# ------------------------ рд╕реНрдерд╛рди рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдПрдВ (Track Location) Page ------------------------
elif page == "ЁЯУН рд╕реНрдерд╛рди рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдПрдВ":
    st.title("ЁЯУН рдкреНрд░рд┐рдпрдЬрди рдХрд╛ рд╕реНрдерд╛рди рдкрддрд╛ рд▓рдЧрд╛рдПрдВ")

    user_email = st.text_input("ЁЯУз рдЖрдкрдХрд╛ рдИрдореЗрд▓", placeholder="рдЕрдкрдирд╛ рдИрдореЗрд▓ рджрд░реНрдЬ рдХрд░реЗрдВ")
    user_password = st.text_input("ЁЯФС рдЖрдкрдХрд╛ рдИрдореЗрд▓ рдкрд╛рд╕рд╡рд░реНрдб", type="password", placeholder="рдЕрдкрдирд╛ рдкрд╛рд╕рд╡рд░реНрдб рджрд░реНрдЬ рдХрд░реЗрдВ")

    # рд╕реНрдерд╛рди рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХрд╛ рдмрдЯрди (рд▓рд┐рдВрдХ рдкрд░ рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ рдХрд░рддрд╛ рд╣реИ)
    if st.button("ЁЯЪА рдкреНрд░рд┐рдпрдЬрди рдХрд╛ рд╕реНрдерд╛рди рдкрддрд╛ рд▓рдЧрд╛рдПрдВ"):
        st.markdown("[ЁЯФЧ рдпрд╣рд╛рдВ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ рд╕реНрдерд╛рди рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХреЗ рд▓рд┐рдП](https://1543siddhant.github.io/Map-Live-Tracking/)", unsafe_allow_html=True)

# ------------------------ рдЖрдкрд╛рддрдХрд╛рд▓реАрди SOS рдкреНрд░рдгрд╛рд▓реА (Emergency SOS System) Page ------------------------
elif page == "ЁЯЪи рдЖрдкрд╛рддрдХрд╛рд▓реАрди SOS рдкреНрд░рдгрд╛рд▓реА":
    st.title("ЁЯЪи рдЖрдкрд╛рддрдХрд╛рд▓реАрди SOS рдкреНрд░рдгрд╛рд▓реА")
    st.markdown("### тЪая╕П **рддрддреНрдХрд╛рд▓ рд╕рд╣рд╛рдпрддрд╛ рдЪрд╛рд╣рд┐рдП?** рдЕрдкрдирд╛ рд╕реНрдерд╛рди рдФрд░ рд╡рд┐рд╡рд░рдг рдХреЗ рд╕рд╛рде рдЖрдкрд╛рддрдХрд╛рд▓реАрди рдИрдореЗрд▓ рднреЗрдЬреЗрдВред")

    # рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░рд┐рд╕реАрд╡рд░ рдИрдореЗрд▓
    DEFAULT_RECEIVERS = [
        "siddhantpatil1543@gmail.com",
        "siddhantpatil1540@gmail.com"
    ]

    # рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдИрдореЗрд▓ рд╡рд┐рд╖рдп рдФрд░ рд╕рдВрджреЗрд╢
    DEFAULT_SUBJECT = "ЁЯЪи рддрддреНрдХрд╛рд▓: рдЖрдкрд╛рддрдХрд╛рд▓реАрди рд╕рд╣рд╛рдпрддрд╛ рдЖрд╡рд╢реНрдпрдХ!"
    DEFAULT_MESSAGE = "рдореИрдВ рдПрдХ рдЖрдкрд╛рдд рд╕реНрдерд┐рддрд┐ рдореЗрдВ рд╣реВрдБ рдФрд░ рддреБрд░рдВрдд рд╕рд╣рд╛рдпрддрд╛ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ! рдХреГрдкрдпрд╛ рддреБрд░рдВрдд рдорджрдж рдХрд░реЗрдВред"

    # рд░рд┐рд╕реАрд╡рд░ рдИрдореЗрд▓ рдЗрдирдкреБрдЯ (Editable)
    receiver_emails = st.text_area("ЁЯУе рд░рд┐рд╕реАрд╡рд░ рдИрдореЗрд▓ (рдХреЙрдорд╛ рджреНрд╡рд╛рд░рд╛ рдЕрд▓рдЧ)", ", ".join(DEFAULT_RECEIVERS))

    # рд╡рд┐рд╖рдп (рдирд┐рд╢реНрдЪрд┐рдд, рд╕рдВрдкрд╛рджрди рдпреЛрдЧреНрдп рдирд╣реАрдВ)
    st.text_input("ЁЯУМ рд╡рд┐рд╖рдп", DEFAULT_SUBJECT, disabled=True)

    # рд╕рдВрджреЗрд╢ (Editable)
    message = st.text_area("ЁЯУЭ рд╕рдВрджреЗрд╢", DEFAULT_MESSAGE)

    # рдЫрд╡рд┐ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ (рд╡реИрдХрд▓реНрдкрд┐рдХ)
    uploaded_file = st.file_uploader("ЁЯУ╖ рдЫрд╡рд┐ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ (рд╡реИрдХрд▓реНрдкрд┐рдХ)", type=["png", "jpg", "jpeg"])

    # рдЖрдкрд╛рддрдХрд╛рд▓реАрди рдХреЙрд▓ рдФрд░ рд╕реНрдерд╛рди рд╕рд╛рдЭрд╛ рдХрд░рдирд╛
    st.markdown("ЁЯУЮ **рдХреНрдпрд╛ рдЖрдкрдХреЛ рдЖрдкрд╛рддрдХрд╛рд▓реАрди рдХреЙрд▓ рдХрд░рдиреА рд╣реИ?**")
    st.markdown("[ЁЯУ▓ рдЖрдкрд╛рддрдХрд╛рд▓реАрди рд╕реЗрд╡рд╛рдУрдВ рдХреЛ рдХреЙрд▓ рдХрд░реЗрдВ (рднрд╛рд░рдд)](tel:112)")

    st.markdown("ЁЯУН **рддреБрд░рдВрдд рдЕрдкрдирд╛ рд╕реНрдерд╛рди рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ:**")
    if st.button("ЁЯУб рд▓рд╛рдЗрд╡ рд╕реНрдерд╛рди рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ"):
        st.markdown("[ЁЯФЧ рдпрд╣рд╛рдВ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ рдЕрдкрдирд╛ рд╕реНрдерд╛рди рд╕рд╛рдЭрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП](https://1543siddhant.github.io/Map-Live-Tracking/)", unsafe_allow_html=True)

    # рдИрдореЗрд▓ рднреЗрдЬрдиреЗ рдХрд╛ рдмрдЯрди
    if st.button("ЁЯЪА рдЖрдкрд╛рддрдХрд╛рд▓реАрди рдИрдореЗрд▓ рднреЗрдЬреЗрдВ"):
        if receiver_emails and message:
            email_list = [email.strip() for email in receiver_emails.split(",")]
            
            # рдИрдореЗрд▓ рдмрдирд╛рдПрдВ
            msg = EmailMessage()
            msg["From"] = SENDER_EMAIL
            msg["To"] = ", ".join(email_list)
            msg["Subject"] = DEFAULT_SUBJECT
            msg.set_content(message)

            # рдпрджрд┐ рдХреЛрдИ рдЫрд╡рд┐ рдЕрдкрд▓реЛрдб рдХреА рдЧрдИ рд╣реЛ рддреЛ рдЙрд╕реЗ рдЬреЛрдбрд╝реЗрдВ
            if uploaded_file is not None:
                file_data = uploaded_file.read()
                file_name = uploaded_file.name
                msg.add_attachment(file_data, maintype="image", subtype=file_name.split(".")[-1], filename=file_name)

            try:
                server = smtplib.SMTP("smtp.gmail.com", 587)
                server.starttls()
                server.login(SENDER_EMAIL, SENDER_PASSWORD)
                server.send_message(msg)
                server.quit()
                
                st.success(f"тЬЕ рдЖрдкрд╛рддрдХрд╛рд▓реАрди рдИрдореЗрд▓ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рднреЗрдЬ рджреА рдЧрдИ рд╣реИ: {', '.join(email_list)}")
            except Exception as e:
                st.error(f"тЭМ рдИрдореЗрд▓ рднреЗрдЬрдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓: {e}")
        else:
            st.warning("тЪая╕П рдХреГрдкрдпрд╛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рднреЗрдЬрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рд╕рднреА рдлрд╝реАрд▓реНрдб рднрд░реЗ рдЧрдП рд╣реИрдВред")
